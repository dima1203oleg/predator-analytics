# Secrets checklist and minimal runbook for autofix loop

This document enumerates the repository secrets, variables, and recommended policies needed to safely run the autofix loop and related automation in this repo.

## Required repository secrets / variables

- `GITHUB_TOKEN` (automatically provided by GH Actions) — used to create issues/PRs/comments.
- `GEMINI_API_KEY` — optional (Gemini/Google GenAI) used for generating AI patches. Only required if you enable the AI remediation steps.
- `AI_STUDIO_UPLOAD_ENDPOINT` / `AI_STUDIO_TOKEN` — optional: used by `push_to_ai_studio.sh` and CI steps which push packages/exports to AI Studio.
- `GHCR_PAT` — optional: token for pushing images to GH Container Registry if CI builds/publishes images.
- `ARGOCD_*` secrets — set if you run token generation automation; examples:
  - `ARGOCD_MAC_URL`, `ARGOCD_MAC_USERNAME`, `ARGOCD_MAC_PASSWORD`
  - `ARGOCD_NVIDIA_URL`, `ARGOCD_NVIDIA_USERNAME`, `ARGOCD_NVIDIA_PASSWORD`
  - `ARGOCD_ORACLE_URL`, `ARGOCD_ORACLE_USERNAME`, `ARGOCD_ORACLE_PASSWORD`
  - `ARGOCD_*_TOKEN` (generated by workflows, not required to set manually when using token workflow)
- `ALLOW_AUTO_MERGE` — boolean-style secret for gating auto-merge behavior in the autofix loop. Default should be `false`. Set to `true` only after review & safeguards are in place.

## Recommended repository variables (GitHub repo-level variables)

- `GEMINI_CLI_VERSION`, `GCP_WIF_PROVIDER`, `GOOGLE_CLOUD_PROJECT`, `GOOGLE_CLOUD_LOCATION`, `SERVICE_ACCOUNT_EMAIL` — used by Gemini CLI tasks and VertexAI when using workload identity.
- `AI_ISSUE_ASSIGNEES` — mapping for responsibility assignment, e.g. `macbook:alice,bob;nvidia:ops;default:ops-team`.
- `AI_BLOCK_THRESHOLD` — default severity threshold (e.g. `CRITICAL`) used by automations to decide whether to fail CI or open issues.

## Minimal safety runbook to enable autofix loop (recommended sequence)

1. Keep `ALLOW_AUTO_MERGE=false` by default. Ensure autofix PRs target `autofix/staging` (already default in workflows).
2. Add `GEMINI_API_KEY` only in a stable staging environment for testing. Keep AI actions limited to creating an issue + suggested diff — prefer human review before applying.
3. Run the `autofix-loop-test.yml` (manual dispatch) with `simulate_patch=true` and confirm protective checks prevent deleting Helm `Chart.yaml` and `templates` files.
4. Run `check-actionlint.yml` and `yamllint` CI checks to ensure workflows are valid and lint-clean before enabling auto-merge.
5. If you want to enable `ALLOW_AUTO_MERGE=true` for a stage branch, first require branch-protection rules and required status checks on that branch so only validated PRs can merge.
6. For production `main` auto-merge: strongly prefer a review step (human in the loop). Only enable auto-merge for `autofix/staging` → `main` once you have confidence and monitoring in place.

## Emergency rollback and detection

- If the autofix loop creates a problematic PR or merges unwanted changes, revert quickly and inspect the workflow run logs and AI-produced patch. Require an audit trail in issue comments (works by default).
- Consider creating an alerting path (Slack, email) from the autofix workflows to notify engineers when an autofix PR is created or automerged.

## Next steps (if you want me to continue)

- I can trigger the `autofix-loop-test.yml` for you (manual dispatch) and/or add a helper `scripts/run_autofix_test.sh` that calls `gh` CLI.
- I can also produce a short `README` runbook for operators describing how to safely turn on automerge for `autofix/staging` and how to add vault-backed secrets.

---
Generated automatically by repository automation — edit as needed.
