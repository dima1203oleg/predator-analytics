name: Create PR for fixes + Auto-approve & Auto-merge

on:
  push:
    branches:
      - "fix/**"

permissions:
  contents: write
  pull-requests: write
  checks: write

env:
  BASE_BRANCH: main

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (ua-sources)
        run: |
          cd apps/backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-asyncio httpx || true

      - name: Run tests
        id: run_tests
        run: |
          set -eux
          cd apps/backend
          python -m pytest tests/ -q

      - name: Finalize results
        id: set_output
        run: |
          echo "tests=$([[ -d apps/backend/.pytest_cache ]] && echo passed || echo failed)" >> "$GITHUB_OUTPUT"

  create-or-update-pr:
    name: Create or Update Pull Request
    runs-on: ubuntu-latest
    needs: build-and-test
    if: needs.build-and-test.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create or update PR to main (add labels auto-approve, automerge)
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.ref.replace('refs/heads/','');
            const base = process.env.BASE_BRANCH || 'main';
            const title = `Auto PR: ${branch} -> ${base}`;
            const body = `Automated PR created from branch ${branch} after CI tests passed.`;

            // find existing PR from branch
            const pulls = await github.rest.pulls.list({ owner, repo, head: `${owner}:${branch}`, state: 'open' });
            if (pulls.data && pulls.data.length > 0) {
              const pr = pulls.data[0];
              // add labels
              const labels = ['auto-approve','automerge'];
              await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels });
              core.setOutput('pull-request-number', String(pr.number));
              core.setOutput('pull-request-url', pr.html_url);
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, head: branch, base, title, body });
              // add labels
              const labels = ['auto-approve','automerge'];
              await github.rest.issues.addLabels({ owner, repo, issue_number: pr.data.number, labels });
              core.setOutput('pull-request-number', String(pr.data.number));
              core.setOutput('pull-request-url', pr.data.html_url);
            }

      - name: Enable auto-merge for PR (if allowed by repo variables)
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs['pull-request-number'] }}
          merge-method: squash

      - name: Comment PR with summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = Number('${{ steps.create_pr.outputs['pull-request-number'] }}');
            if (prNumber) {
              await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: 'Automated tests passed. PR labeled for auto-approve and auto-merge.' });
            }
