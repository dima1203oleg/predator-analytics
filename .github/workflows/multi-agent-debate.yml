# Multi-Agent Debate: Defender vs Innovator using Gemini CLI
# Requirements (set these in repo Settings -> Secrets & variables -> Actions):
# Secrets:
#   - GEMINI_API_KEY
# Variables:
#   - GEMINI_CLI_VERSION
#   - GCP_WIF_PROVIDER
#   - GOOGLE_CLOUD_PROJECT
#   - GOOGLE_CLOUD_LOCATION
#   - SERVICE_ACCOUNT_EMAIL
#   - GOOGLE_GENAI_USE_VERTEXAI
#   - GOOGLE_GENAI_USE_GCA

name: "ðŸ§  Multi-Agent Debate (Defender vs Innovator)"

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write
  statuses: write

jobs:
  defender-review:
    name: "Defender: Security & Cost"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Run Gemini Defender review
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_defender
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ vars.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ vars.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            ROLE: You are DEFENDER agent.
            Focus ONLY on:
            - security risks (secrets, tokens, network access, RBAC)
            - stability and reliability of Kubernetes + ArgoCD
            - cloud cost and resource limits (CPU, RAM, GPU)
            - safety for MacBook dev cluster (low resources)

            TASK:
            1. Analyze the diff of this PR.
            2. Find DIRECT risks:
               - secret leakage
               - unsafe ports/Ingress
               - oversized resources (especially for dev/macbook).
            3. Produce a short list:
               - [SEVERITY] issue description
               - suggested fix.
            4. Post result as a comment on the PR.

  innovator-review:
    name: "Innovator: Performance & Features"
    runs-on: ubuntu-latest
    needs: defender-review
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Run Gemini Innovator review
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_innovator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ vars.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ vars.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            ROLE: You are INNOVATOR agent.
            Focus ONLY on:
            - performance improvement
            - UX and DevEx
            - auto-scaling, resilience, observability
            - future features for Predator Analytics

            TASK:
            1. Analyze the diff of this PR.
            2. Suggest where to:
               - speed up code
               - improve CI/CD pipelines
               - simplify YAML/Helm structure
               - enhance monitoring/alerts.
            3. Add concrete proposals (lists + examples).
            4. Post result as a comment on the PR.

  summary-judge:
    name: "Judge: Summary of Debate"
    runs-on: ubuntu-latest
    needs: [defender-review, innovator-review]
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Gemini Judge summary
        uses: google-github-actions/run-gemini-cli@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ vars.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ vars.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            ROLE: You are JUDGE agent.
            INPUT:
            - Read comments from DEFENDER and INNOVATOR in this PR.
            TASK:
            1. Make a very short summary:
               - must-fix BEFORE merge (safety)
               - optimizations worth doing but not blocking
            2. Form two blocks:
               - MUST FIX BEFORE MERGE
               - NICE TO HAVE
            3. Post as one summarizing comment in the PR.
