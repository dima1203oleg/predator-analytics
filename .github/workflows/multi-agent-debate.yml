# Multi-Agent Debate: Defender vs Innovator using Gemini CLI
# Requirements (set these in repo Settings -> Secrets & variables -> Actions):
# Secrets:
#   - GEMINI_API_KEY
# Variables:
#   - GEMINI_CLI_VERSION
#   - GCP_WIF_PROVIDER
#   - GOOGLE_CLOUD_PROJECT
#   - GOOGLE_CLOUD_LOCATION
#   - SERVICE_ACCOUNT_EMAIL
#   - GOOGLE_GENAI_USE_VERTEXAI
#   - GOOGLE_GENAI_USE_GCA

name: "ðŸ§  Multi-Agent Debate (Defender vs Innovator)"

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write
  statuses: write

jobs:
  defender-review:
    name: "Defender: Security & Cost"
    runs-on: ubuntu-latest
    env:
      GEMINI_CLI_VERSION: ${{ vars.GEMINI_CLI_VERSION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
      SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
      GOOGLE_GENAI_USE_VERTEXAI: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
      GOOGLE_GENAI_USE_GCA: ${{ vars.GOOGLE_GENAI_USE_GCA }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Run Gemini Defender review
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_defender
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            # CONTEXT: Predator v18.2 â€” cluster rules & expectations
            CLUSTERS:
            - macbook: dev cluster â€” very limited CPU/memory, single-node, prefer small resource requests, replicas=1, avoid heavy probes and large images
            - nvidia: gpu cluster â€” workloads may request GPUs, allow GPU quotas, ensure nodeSelector/tolerations for GPU nodes
            - oracle: cloud free-tier / minimal â€” limited IOPS and networking, avoid large PVs, avoid bursty autoscaling

            ROLE: You are DEFENDER agent.
            Focus ONLY on:
            - security risks (secrets, tokens, network access, RBAC)
            - stability and reliability of Kubernetes + ArgoCD
            - cloud cost and resource limits (CPU, RAM, GPU)
            - safety for MacBook dev cluster (low resources)

            TASK:
            1. Analyze the diff of this PR. Detect which environment(s) are touched by checking file paths (e.g. environments/macbook/, environments/nvidia/, environments/oracle/).
            2. Find DIRECT risks for the clusters (call out which cluster is impacted):
               - secret leakage
               - unsafe ports/Ingress
               - oversized resources (especially for dev/macbook).
            3. Produce a short list (per-cluster if applicable):
              - [SEVERITY] issue description
              - suggested fix.
            4. Format the comment as a short checklist and append a single-line machine-readable severity marker at the end of the comment in this exact format (use one of CRITICAL, HIGH, MEDIUM, LOW):
              <!-- AI_REVIEW_SEVERITY: CRITICAL -->
            4. Post result as a comment on the PR.

  innovator-review:
    name: "Innovator: Performance & Features"
    runs-on: ubuntu-latest
    needs: defender-review
    env:
      GEMINI_CLI_VERSION: ${{ vars.GEMINI_CLI_VERSION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
      SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
      GOOGLE_GENAI_USE_VERTEXAI: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
      GOOGLE_GENAI_USE_GCA: ${{ vars.GOOGLE_GENAI_USE_GCA }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Run Gemini Innovator review
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_innovator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            # CONTEXT: Predator v18.2 â€” cluster rules & expectations
            CLUSTERS:
            - macbook: dev cluster â€” very limited CPU/memory, single-node, prefer small resource requests, replicas=1, avoid heavy probes and large images
            - nvidia: gpu cluster â€” workloads may request GPUs, allow GPU quotas, ensure nodeSelector/tolerations for GPU nodes
            - oracle: cloud free-tier / minimal â€” limited IOPS and networking, avoid large PVs, avoid bursty autoscaling

            ROLE: You are INNOVATOR agent.
            Focus ONLY on:
            - performance improvement
            - UX and DevEx
            - auto-scaling, resilience, observability
            - future features for Predator Analytics

            TASK:
            1. Analyze the diff of this PR. Detect which environment(s) are touched by checking file paths (e.g. environments/macbook/, environments/nvidia/, environments/oracle/). Prioritize recommendations for the environments changed.
            2. Suggest where to:
               - speed up code
               - improve CI/CD pipelines
               - simplify YAML/Helm structure
               - enhance monitoring/alerts.
            3. Add concrete proposals (lists + examples).
            4. Format the comment as a short checklist and append a single-line machine-readable severity marker at the end of the comment in this exact format (one of CRITICAL, HIGH, MEDIUM, LOW):
              <!-- AI_REVIEW_SEVERITY: LOW -->
            4. Post result as a comment on the PR.

  summary-judge:
    name: "Judge: Summary of Debate"
    runs-on: ubuntu-latest
    needs: [defender-review, innovator-review]
    env:
      GEMINI_CLI_VERSION: ${{ vars.GEMINI_CLI_VERSION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
      SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
      GOOGLE_GENAI_USE_VERTEXAI: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
      GOOGLE_GENAI_USE_GCA: ${{ vars.GOOGLE_GENAI_USE_GCA }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

  defender-evaluator:
    name: "Defender evaluator (block on CRITICAL)"
    runs-on: ubuntu-latest
    needs: defender-review
    steps:
      - name: Check Defender severity in PR comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 200 });
            // Find the latest comment that contains the marker
            const marker = 'AI_REVIEW_SEVERITY:';
            const reversed = comments.slice().reverse();
            const found = reversed.find(c => c.body && c.body.includes(marker));
            if (!found) {
              core.info('No AI_REVIEW_SEVERITY marker found in PR comments â€” continuing.');
              return {severity: 'NONE'};
            }
            const m = found.body.match(/AI_REVIEW_SEVERITY:\s*(CRITICAL|HIGH|MEDIUM|LOW)/i);
            if (!m) {
              core.info('AI_REVIEW_SEVERITY marker present but no level parsed â€” continuing.');
              return {severity: 'UNKNOWN'};
            }
            const level = m[1].toUpperCase();
            core.info('Parsed severity: ' + level);
            if (level === 'CRITICAL') {
              core.setFailed('Defender reported CRITICAL severity â€” blocking PR (defender-evaluator).');
            }
            return {severity: level};

      - name: Gemini Judge summary
        uses: google-github-actions/run-gemini-cli@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            # CONTEXT: Predator v18.2 â€” cluster rules & expectations
            CLUSTERS:
            - macbook: dev cluster â€” very limited CPU/memory, single-node, prefer small resource requests, replicas=1, avoid heavy probes and large images
            - nvidia: gpu cluster â€” workloads may request GPUs, allow GPU quotas, ensure nodeSelector/tolerations for GPU nodes
            - oracle: cloud free-tier / minimal â€” limited IOPS and networking, avoid large PVs, avoid bursty autoscaling

            ROLE: You are JUDGE agent.
            INPUT:
            - Read comments from DEFENDER and INNOVATOR in this PR.
            TASK:
            1. Make a very short summary: include which environment(s) you considered (macbook/nvidia/oracle) and why.
               - must-fix BEFORE merge (safety)
               - optimizations worth doing but not blocking
            2. Form two blocks:
               - MUST FIX BEFORE MERGE
               - NICE TO HAVE
            3. Post as one summarizing comment in the PR.
            4. At the end of your summary add the marker in the same format so automated checks can scan for it: <!-- AI_REVIEW_SEVERITY: HIGH -->
