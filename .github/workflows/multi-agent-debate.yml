# Multi-Agent Debate: Defender vs Innovator using Gemini CLI
# Requirements (set these in repo Settings -> Secrets & variables -> Actions):
# Secrets:
#   - GEMINI_API_KEY
# Variables:
#   - GEMINI_CLI_VERSION
#   - GCP_WIF_PROVIDER
#   - GOOGLE_CLOUD_PROJECT
#   - GOOGLE_CLOUD_LOCATION
#   - SERVICE_ACCOUNT_EMAIL
#   - GOOGLE_GENAI_USE_VERTEXAI
#   - GOOGLE_GENAI_USE_GCA

name: "ðŸ§  Multi-Agent Debate (Defender vs Innovator)"

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write
  statuses: write

jobs:
  path-filter:
    name: Detect changed environments
    runs-on: ubuntu-latest
    outputs:
      envs: ${{ steps.build.outputs.envs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Filter paths for environments
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            macbook:
              - 'environments/macbook/**'
            nvidia:
              - 'environments/nvidia/**'
            oracle:
              - 'environments/oracle/**'

      - name: Build envs JSON list
        id: build
        run: |
          envs=""
          if [ "${{ steps.filter.outputs.macbook }}" = "true" ]; then envs="$envs\"macbook\","; fi
          if [ "${{ steps.filter.outputs.nvidia }}" = "true" ]; then envs="$envs\"nvidia\","; fi
          if [ "${{ steps.filter.outputs.oracle }}" = "true" ]; then envs="$envs\"oracle\","; fi
          envs="[${envs%,}]"
          echo "envs=$envs" >> $GITHUB_OUTPUT

  # Per-environment analysis: Defender + Innovator run per touched environment (parallel)
  env-analysis:
    name: "Env analysis â€” ${{ matrix.env }}"
    needs: path-filter
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        env: ${{ fromJson(needs.path-filter.outputs.envs) }}
    if: ${{ needs.path-filter.outputs.envs != '[]' }}
    env:
      GEMINI_CLI_VERSION: ${{ vars.GEMINI_CLI_VERSION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
      SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
      GOOGLE_GENAI_USE_VERTEXAI: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
      GOOGLE_GENAI_USE_GCA: ${{ vars.GOOGLE_GENAI_USE_GCA }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Defender (env-aware)
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_defender
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            CONTEXT: Running Defender analysis for environment: ${{ matrix.env }}
            ROLE: You are DEFENDER agent.
            Focus ONLY on: security, stability, costs and resource limits for this environment.
            TASK:
            - Analyze changed files, check environment ${matrix.env} paths.
            - Output a checklist, include severity marker: <!-- AI_REVIEW_SEVERITY: CRITICAL|HIGH|MEDIUM|LOW -->

      - name: Check defender severity + create issue on CRITICAL
        uses: actions/github-script@v7
        env:
          MATRIX_ENV: ${{ matrix.env }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 200 });
            const marker = 'AI_REVIEW_SEVERITY:';
            const reversed = comments.slice().reverse();
            // find latest comment that mentions this environment + marker
            const found = reversed.find(c => c.body && c.body.includes(marker) && c.body.includes(`environment: ${process.env.MATRIX_ENV}`));
            if (!found) {
              core.info('No AI_REVIEW_SEVERITY marker found for env ' + process.env.MATRIX_ENV + ' â€” continuing.');
              return {severity: 'NONE'};
            }
            const m = found.body.match(/AI_REVIEW_SEVERITY:\s*(CRITICAL|HIGH|MEDIUM|LOW)/i);
            if (!m) {
              core.info('AI_REVIEW_SEVERITY marker present but no level parsed â€” continuing.');
              return {severity: 'UNKNOWN'};
            }
            const level = m[1].toUpperCase();
            core.info('Parsed severity for env ' + process.env.MATRIX_ENV + ': ' + level);
            if (level === 'CRITICAL') {
              // create issue if not exists
              const issueTitle = `AI Defender CRITICAL â€” PR #${prNumber} (${process.env.MATRIX_ENV})`;
              const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
              const exists = issues.find(i => i.title === issueTitle);
              if (!exists) {
                const body = 'Defender reported CRITICAL severity for environment ' + process.env.MATRIX_ENV + ' in PR #' + prNumber + "\n\nLatest defender comment:\n\n" + found.body + "\n\nPlease address immediately.";
                await github.rest.issues.create({ owner, repo, title: issueTitle, body: body });
                core.info('Created issue: ' + issueTitle);
              } else {
                core.info('Open issue already exists: ' + exists.html_url);
              }
              core.setFailed('Defender reported CRITICAL severity for env ' + process.env.MATRIX_ENV + ' â€” failing job.');
            }
            return {severity: level};

      - name: Innovator (env-aware)
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_innovator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            CONTEXT: Running Innovator analysis for environment: ${{ matrix.env }}
            ROLE: You are INNOVATOR agent.
            Focus ONLY on: performance, developer experience and scalability suggestions for this environment.
            TASK:
            - Analyze changed files, check environment ${matrix.env} paths.
            - Output checklist + improvement suggestions and include severity marker.
  # Fallback global analysis when no environment-specific paths are changed
  global-analysis:
    name: Global analysis (no environment paths changed)
    needs: path-filter
    runs-on: ubuntu-latest
    if: ${{ needs.path-filter.outputs.envs == '[]' }}
    env:
      GEMINI_CLI_VERSION: ${{ vars.GEMINI_CLI_VERSION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
      SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
      GOOGLE_GENAI_USE_VERTEXAI: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
      GOOGLE_GENAI_USE_GCA: ${{ vars.GOOGLE_GENAI_USE_GCA }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Defender (global)
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_defender
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            CONTEXT: Running Defender global analysis (no env-specific files changed)
            ROLE: You are DEFENDER agent.
            Focus ONLY on: security, stability and cost impact at repo-level.
            TASK:
            - Analyze the full diff and surface any critical issues.

      - name: Check defender severity + create issue on CRITICAL
        uses: actions/github-script@v7
        env:
          MATRIX_ENV: global
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 200 });
            const marker = 'AI_REVIEW_SEVERITY:';
            const reversed = comments.slice().reverse();
            // find latest comment with marker
            const found = reversed.find(c => c.body && c.body.includes(marker));
            if (!found) {
              core.info('No AI_REVIEW_SEVERITY marker found (global) â€” continuing.');
              return {severity: 'NONE'};
            }
            const m = found.body.match(/AI_REVIEW_SEVERITY:\s*(CRITICAL|HIGH|MEDIUM|LOW)/i);
            if (!m) {
              core.info('AI_REVIEW_SEVERITY marker present but no level parsed â€” continuing.');
              return {severity: 'UNKNOWN'};
            }
            const level = m[1].toUpperCase();
            core.info('Parsed severity (global): ' + level);
            if (level === 'CRITICAL') {
              const issueTitle = `AI Defender CRITICAL â€” PR #${prNumber} (global)`;
              const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
              const exists = issues.find(i => i.title === issueTitle);
              if (!exists) {
                const body = 'Defender reported CRITICAL severity for the repository in PR #' + prNumber + "\n\nLatest defender comment:\n\n" + found.body + "\n\nPlease address immediately.";
                await github.rest.issues.create({ owner, repo, title: issueTitle, body: body });
                core.info('Created issue: ' + issueTitle);
              } else {
                core.info('Open issue already exists: ' + exists.html_url);
              }
              core.setFailed('Defender reported CRITICAL severity (global) â€” failing job.');
            }
            return {severity: level};

      - name: Innovator (global)
        uses: google-github-actions/run-gemini-cli@v0
        id: gemini_innovator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            CONTEXT: Running Innovator global analysis (no env-specific files changed)
            ROLE: You are INNOVATOR agent.
            Focus ONLY on: performance, CI/CD, and repository-level improvements.
            TASK:
            - Analyze the full diff and propose improvements.

  workflow-lint:
    name: "Workflow lint (super-linter)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint workflows with Super-Linter
        uses: github/super-linter@v4
        env:
          VALIDATE_WORKFLOW: true
          INPUT_INCLUDE: .github/workflows
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  actionlint:
    name: "Actionlint (validate workflows)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run actionlint
        uses: rhysd/actionlint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          args: |
            --config .actionlint.yml || true

  # summary-judge definition moved below (keeps full judge step)

  defender-evaluator:
    name: "Defender evaluator (block on CRITICAL)"
    runs-on: ubuntu-latest
    needs: [env-analysis, global-analysis]
    steps:
      - name: Check Defender severity in PR comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber, per_page: 200 });
            // Find the latest comment that contains the marker
            const marker = 'AI_REVIEW_SEVERITY:';
            const reversed = comments.slice().reverse();
            const found = reversed.find(c => c.body && c.body.includes(marker));
            if (!found) {
              core.info('No AI_REVIEW_SEVERITY marker found in PR comments â€” continuing.');
              return {severity: 'NONE'};
            }
            const m = found.body.match(/AI_REVIEW_SEVERITY:\s*(CRITICAL|HIGH|MEDIUM|LOW)/i);
            if (!m) {
              core.info('AI_REVIEW_SEVERITY marker present but no level parsed â€” continuing.');
              return {severity: 'UNKNOWN'};
            }
            const level = m[1].toUpperCase();
            core.info('Parsed severity: ' + level);
            if (level === 'CRITICAL') {
              core.setFailed('Defender reported CRITICAL severity â€” blocking PR (defender-evaluator).');
            }
            return {severity: level};

  summary-judge:
    name: "Judge: Summary of Debate"
    runs-on: ubuntu-latest
    needs: [env-analysis, global-analysis]
    env:
      GEMINI_CLI_VERSION: ${{ vars.GEMINI_CLI_VERSION }}
      GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
      GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_CLOUD_LOCATION: ${{ vars.GOOGLE_CLOUD_LOCATION }}
      SERVICE_ACCOUNT_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
      GOOGLE_GENAI_USE_VERTEXAI: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
      GOOGLE_GENAI_USE_GCA: ${{ vars.GOOGLE_GENAI_USE_GCA }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4

      - name: Gemini Judge summary
        uses: google-github-actions/run-gemini-cli@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          gemini_cli_version: ${{ env.GEMINI_CLI_VERSION }}
          gcp_workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ env.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          use_vertex_ai: ${{ env.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ env.GOOGLE_GENAI_USE_GCA }}
          prompt: |
            # CONTEXT: Predator v18.2 â€” cluster rules & expectations
            CLUSTERS:
            - macbook: dev cluster â€” very limited CPU/memory, single-node, prefer small resource requests, replicas=1, avoid heavy probes and large images
            - nvidia: gpu cluster â€” workloads may request GPUs, allow GPU quotas, ensure nodeSelector/tolerations for GPU nodes
            - oracle: cloud free-tier / minimal â€” limited IOPS and networking, avoid large PVs, avoid bursty autoscaling

            ROLE: You are JUDGE agent.
            INPUT:
            - Read comments from DEFENDER and INNOVATOR in this PR.
            TASK:
            1. Make a very short summary: include which environment(s) you considered (macbook/nvidia/oracle) and why.
               - must-fix BEFORE merge (safety)
               - optimizations worth doing but not blocking
            2. Form two blocks:
               - MUST FIX BEFORE MERGE
               - NICE TO HAVE
            3. Post as one summarizing comment in the PR.
            4. At the end of your summary add the marker in the same format so automated checks can scan for it: <!-- AI_REVIEW_SEVERITY: HIGH -->
