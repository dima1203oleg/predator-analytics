name: Autofix Loop — Manual Test

on:
  workflow_dispatch:
    inputs:
      simulate_patch:
        description: 'If true, create a simulated AI patch that deletes a Chart.yaml (tests protection)'
        required: false
        default: 'false'

jobs:
  run-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare simulated AI patch
        if: ${{ github.event.inputs.simulate_patch == 'true' }}
        run: |
          set -eux
          # Use a small helper script to produce an ai patch file to avoid embedding long heredocs in the workflow
          scripts/simulate_ai_patch.sh macbook

      - name: Run apply logic (local simulation)
        run: |
          set -eux
          if [ -f /tmp/ai_patch.diff ]; then
            echo "Found /tmp/ai_patch.diff, running safety checks..."
          else
            echo "No patch provided; creating a small harmless patch to modify README.md"
            echo "--- a/README.md" > /tmp/ai_patch.diff
            echo "+++ b/README.md" >> /tmp/ai_patch.diff
            echo "@@" >> /tmp/ai_patch.diff
            echo "-Old" >> /tmp/ai_patch.diff
            echo "+New (test)" >> /tmp/ai_patch.diff
          fi

          # Safety check similar to the real workflow — match added/modified/deleted Chart.yaml/templates patterns
          # break checks into several shorter grep calls to avoid long single lines
          if grep -qE '^\+\+\+\s+b/environments/.+/(Chart.yaml|templates/)' /tmp/ai_patch.diff; then
            echo "PROTECTION: Patch attempts to modify or add environments/* Chart.yaml/templates — refusing to apply." && exit 0
          fi
          if grep -qE '^---\s+a/environments/.+/(Chart.yaml|templates/)' /tmp/ai_patch.diff; then
            echo "PROTECTION: Patch attempts to modify or delete environments/* Chart.yaml/templates — refusing to apply." && exit 0
          fi
          if grep -qE '^deleted file mode.*environments/.+/(Chart.yaml|templates/)' /tmp/ai_patch.diff; then
            echo "PROTECTION: Patch deletes environments/* Chart.yaml — refusing to apply." && exit 0
          fi

          echo "Patch passed safety checks (or harmless). Attempting to apply (dry-run)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git switch -c "autofix-test/${{ github.run_id }}" || true
          if git apply --index /tmp/ai_patch.diff; then
            echo "Patch applies cleanly (dry-run)."
          else
            echo "Patch did not apply cleanly (expected for some diffs)." && exit 0
          fi
