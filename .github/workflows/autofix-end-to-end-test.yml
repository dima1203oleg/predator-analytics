name: Autofix Loop — End-to-end test

on:
  workflow_dispatch:
    inputs:
      simulate_patch:
        description: 'If true, create a simulated AI patch that deletes a Chart.yaml'
        required: false
        default: 'true'

jobs:
  run-e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare simulated AI patch
        if: ${{ github.event.inputs.simulate_patch == 'true' }}
        run: |
          set -eux
          ./scripts/simulate_ai_patch.sh macbook

      - name: Run safety checks
        id: run_safety
        run: |
          set -eux
          if [ -f /tmp/ai_patch.diff ]; then
            echo "Found /tmp/ai_patch.diff, running safety checks..."
          else
            echo "No patch present — aborting test" && exit 78
          fi

          # refuse attempt to add/modify/delete Helm Chart.yaml or templates under environments/
          if grep -qE '(^\+\+\+\s+b/environments/.+/(Chart.yaml|templates/))' /tmp/ai_patch.diff; then
            echo "PROTECTION: Patch attempts to add/modify environments/* Chart.yaml/templates — refusing to apply." && exit 0
          fi
          if grep -qE '(^---\s+a/environments/.+/(Chart.yaml|templates/))' /tmp/ai_patch.diff; then
            echo "PROTECTION: Patch attempts to delete/modify environments/* Chart.yaml/templates — refusing to apply." 
            echo "refused=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "refused=false" >> "$GITHUB_OUTPUT"

      - name: Apply patch locally and push branch
        id: apply_and_push
        if: ${{ steps.run_safety.outputs.refused != 'true' }}
        run: |
          set -eux
          git switch -c "autofix-e2e/${{ github.run_id }}"
          if git apply --index /tmp/ai_patch.diff; then
            git add -A
            git commit -m "Autofix e2e test (run ${{ github.run_id }})"
            echo "applied=true" >> "$GITHUB_OUTPUT"
          else
            echo "applied=false" >> "$GITHUB_OUTPUT"
            echo "Patch did not apply cleanly; aborting test" && exit 0
          fi
          git push --set-upstream origin "autofix-e2e/${{ github.run_id }}"

      - name: Create PR to autofix/staging (github-script)
        id: create_pr
        if: ${{ steps.apply_and_push.outputs.applied == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = `autofix-e2e/${{ github.run_id }}`;
            const base = 'autofix/staging';
            const title = `E2E Autofix test — workflow run #${{ github.run_id }}`;
            const body = `E2E test: simulated AI patch created a PR into autofix/staging`;
            const pr = await github.rest.pulls.create({ owner, repo, title, head: branch, base, body });
            core.setOutput('pull-request-number', String(pr.data.number));
            core.setOutput('pull-request-url', pr.data.html_url);

      - name: Determine whether auto-merge is allowed (repo variable)
        id: check_automerge
        if: ${{ steps.apply_and_push.outputs.applied == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          echo "Checking for repo variable ALLOW_AUTO_MERGE via REST API"
          resp=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/variables")
            allow=$(echo "$resp" | python3 -c 'import sys,json; d=json.load(sys.stdin); print(next((v.get("value","") for v in d.get("variables",[]) if v.get("name")=="ALLOW_AUTO_MERGE"), ""))')
          echo "got: $allow"
          if [ "$allow" = "true" ]; then
            echo "allow=true" >> "$GITHUB_OUTPUT"
          else
            echo "allow=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Enable auto-merge on the PR if allowed
        if: ${{ steps.apply_and_push.outputs.applied == 'true' && steps.check_automerge.outputs.allow == 'true' }}
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash

      - name: Final note
        run: |
          if [ "${{ steps.apply_and_push.outputs.applied }}" = "true" ]; then
            echo "E2E test finished — created PR ${{ steps.create_pr.outputs.pull-request-url }}"
          else
            echo "E2E test finished — no PR created (patch refused or did not apply)."
          fi
