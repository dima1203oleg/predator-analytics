apiVersion: v1
kind: ConfigMap
metadata:
  name: predator-backend-config
  namespace: predator-analytics
  labels:
    app.kubernetes.io/name: predator-analytics
    app.kubernetes.io/component: backend
data:
  LOG_LEVEL: "INFO"
  ENVIRONMENT: "production"
  LLM_DEFAULT_PROVIDER: "gemini"
  ML_MODEL_CACHE_TTL: "3600"
  OPENSEARCH_URL: "http://opensearch:9200"
  QDRANT_URL: "http://qdrant:6333"
  MINIO_ENDPOINT: "minio:9000"
  PRELOAD_MODELS: "false"
  MAX_WORKERS: "4"
  CORS_ORIGINS: "*"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: predator-frontend-config
  namespace: predator-analytics
  labels:
    app.kubernetes.io/name: predator-analytics
    app.kubernetes.io/component: frontend
data:
  VITE_API_URL: "/api/v1"
  VITE_KEYCLOAK_URL: "http://keycloak:8080"
  VITE_KEYCLOAK_REALM: "predator"
  VITE_KEYCLOAK_CLIENT_ID: "predator-frontend"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: predator-analytics
  labels:
    app.kubernetes.io/name: predator-analytics
    app.kubernetes.io/component: frontend
data:
  nginx.conf: |
    worker_processes auto;
    events {
        worker_connections 1024;
    }
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        sendfile on;
        keepalive_timeout 65;
        
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
        
        server {
            listen 80;
            server_name _;
            root /usr/share/nginx/html;
            index index.html;
            
            location / {
                try_files $uri $uri/ /index.html;
            }
            
            location /api {
                proxy_pass http://backend:8000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
            }
            
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opensearch-config
  namespace: predator-analytics
  labels:
    app.kubernetes.io/name: predator-analytics
    app.kubernetes.io/component: search
data:
  opensearch.yml: |
    cluster.name: predator-cluster
    node.name: ${HOSTNAME}
    discovery.type: single-node
    bootstrap.memory_lock: true
    plugins.security.disabled: true
    http.host: 0.0.0.0
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: predator-analytics
  labels:
    app.kubernetes.io/name: predator-analytics
    app.kubernetes.io/component: database
data:
  init.sql: |
    -- Create extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pg_trgm";
    CREATE EXTENSION IF NOT EXISTS "btree_gin";

    -- Create keycloak database
    CREATE DATABASE keycloak;

    -- Create mlflow database
    CREATE DATABASE mlflow;

    -- Grant privileges
    GRANT ALL PRIVILEGES ON DATABASE predator_db TO predator;
    GRANT ALL PRIVILEGES ON DATABASE keycloak TO predator;
    GRANT ALL PRIVILEGES ON DATABASE mlflow TO predator;
